/*! penguinator - v3.2.0 - 2014-03-10
* https://github.com/felina/image-annotator
* Copyright (c) 2014 Alistair Wick <alistair.wk@gmail.com>; Licensed MIT */
!function(a){function b(a,b,d){this.src=a,this.w=b,this.h=d,this.zoomin=null,this.zoomout=null,this.pan=null,this.annotate=null,this.attType=null,this.nextAtt=null,this.prevAtt=null,this.delAtt=null,this.nextFtr=null,this.prevFtr=null,this.title=null,this.parent=null,this.container=null,this.canvas=null,this.attHelper=new c(this),this.cHelper=null,this.x0=0,this.x1=0,this.y0=0,this.y1=0,this.curOp="pan",this.active=!1,this.polyC=0}function c(a){this.parent=a,this.ftrs=[],this.fInd=0,this.aInd=0,this.atts=[new g("rect")],this.curType="rect",this.pInd=0}function d(a){this.parent=a;var b=a.w,c=a.h;this.canvas=a.canvas,this.g=this.canvas[0].getContext("2d"),this.canvas[0].width=b,this.canvas[0].height=c,this.w=b,this.h=c,this.defScale=.9,this.curScale=this.defScale,this.xOffs=0,this.yOffs=0}function e(a,b,c){var d=(b-a.w/2-a.xOffs)/a.curScale,e=(c-a.h/2-a.yOffs)/a.curScale;d<-a.w/2&&(d=-a.w/2),d>a.w/2&&(d=a.w/2),e<-a.h/2&&(e=-a.h/2),e>a.h/2&&(e=a.h/2);var f={x:d,y:e};return f}function f(a,b,c){this.name=a,this.req=b,this.shape=c,this.atts=[],this.attC=0}function g(a){this.valid=!1,this.pts=[{x:0,y:0},{x:0,y:0}],this.type=a}var h={position:"relative",overflow:"hidden"},i={position:"absolute",left:0,top:0,"z-index":100,cursor:"move"};b.fn=b.prototype,b.fn.featuresIn=function(a){"undefined"!=typeof a.features&&(this.attHelper.importFeatures(a.features),this.showChange())},b.fn.attsIn=function(a){"undefined"!=typeof a.annotations&&(this.attHelper.importAtts(a.annotations),this.showChange())},b.fn.cssIn=function(a){if("undefined"!=typeof a.style){var b=a.style,c=this.parent.find("button");"undefined"!=typeof b.classes&&c.addClass(b.classes),"undefined"!=typeof b.css&&c.css(b.css)}},b.fn.getExport=function(){return this.attHelper.exportAtts()},b.fn.getFeatures=function(){return this.attHelper.ftrs},b.fn.update=function(a,b,c){this.src=a,this.w=b,this.h=c,this.container.width(b).height(c),this.img.attr("src",a).width(b).height(c),this.cHelper.reset(b,c),this.attHelper.reset()},b.fn.build=function(b){b.addClass("annotator"),b.data("Annotator",this),this.zoomin=a('<button id="zoomin">+</button>').appendTo(b),this.zoomout=a('<button id="zoomout">-</button>').appendTo(b),this.pan=a('<button id="pan">Pan</button>').appendTo(b),this.annotate=a('<button id="annot">Annotate</button>').appendTo(b).css("margin-right","20px"),this.prevFtr=a('<button id="prevFtr">&lt&lt</button>').appendTo(b),this.prevAtt=a('<button id="prevAtt">&lt</button>').appendTo(b),this.attType=a('<select id="typesel"></select>').html("<option>Box</option><option>Polygon</option>").appendTo(b),this.delAtt=a('<button id="nextAtt">X</button>').appendTo(b),this.nextAtt=a('<button id="nextAtt">&gt</button>').appendTo(b),this.nextFtr=a('<button id="nextAtt">&gt&gt</button>').appendTo(b).css("margin-right","20px"),this.title=a("<label>Annotating:</label>").appendTo(b).css("font-family","sans-serif").css("font-size","12px"),this.container=a("<div></div>").css(h).width(this.w).height(this.h).appendTo(b),this.img=a('<img src="'+this.src+'"></img>').hide(),this.canvas=a("<canvas>Unsupported browser.</canvas>").css(i).appendTo(this.container),this.cHelper=new d(this);var c=this;this.zoomin.click(function(){c.cHelper.zoom(1.25)}),this.zoomout.click(function(){c.cHelper.zoom(.8)}),this.attType.change(function(){var b=a(this).val();"Box"===b?(c.attHelper.changeType("rect"),c.switchOp("annotate")):"Polygon"===b&&(c.attHelper.changeType("poly"),c.switchOp("annotate"))}),this.pan.click(function(){c.switchOp("pan")}),this.annotate.click(function(){c.switchOp("annotate")}),this.delAtt.click(function(){c.attHelper.delAtt(),c.updateControls(),c.cHelper.repaint()}),this.prevAtt.click(function(){c.attHelper.prevAtt()}),this.nextAtt.click(function(){c.attHelper.nextAtt()}),this.prevFtr.click(function(){c.attHelper.prevFtr()}),this.nextFtr.click(function(){c.attHelper.nextFtr()}),this.canvas.mousedown(function(a){c.mbDown(a.pageX,a.pageY)}),this.canvas.mousemove(function(a){c.mMove(a.pageX,a.pageY)}),this.canvas.mouseup(function(){c.mbUp()}),this.canvas.dblclick(function(a){c.mbDbl(a)}),this.img.load(function(){c.cHelper.repaint()})},b.fn.showChange=function(){this.cHelper.repaint(),this.updateControls(),this.updateTitle()},b.fn.lockSelect=function(a,b){this.attType.prop("disabled",b),b&&this.attType.val("rect"===a?"Box":"Polygon")},b.fn.updateControls=function(){var a=this.attHelper;this.prevFtr.prop("disabled",0===a.fInd),this.nextFtr.prop("disabled",a.fInd===a.ftrs.length-1),this.prevAtt.prop("disabled",0===a.aInd);var b=a.atts.indexOf(a.getAtt())+1,c=!1;b<a.atts.length&&(c=a.atts[b].valid),this.nextAtt.prop("disabled",!a.getAtt().valid&&!c),this.delAtt.prop("disabled",!a.getAtt().valid)},b.fn.updateTitle=function(){var a=this.attHelper.getFtr().name,b=this.attHelper.fInd,c=this.attHelper.ftrs.length;this.title.text("Annotating: "+a+" ("+(b+1)+"/"+c+")")},b.fn.switchOp=function(a){this.curOp=a,"annotate"===a?this.canvas.css("cursor","crosshair"):this.canvas.css("cursor","move")},b.fn.mbDown=function(a,b){if(!this.active){var c=this.canvas.offset();this.x1=this.x0=a-c.left,this.y1=this.y0=b-c.top,this.active=!0,"annotate"===this.curOp&&this.attHelper.startAtt(e(this.cHelper,this.x0,this.y0))}},b.fn.mbUp=function(){if(this.active&&"annotate"===this.curOp){var a=e(this.cHelper,this.x1,this.y1);this.active=this.attHelper.nextPt(a),this.updateControls()}else this.active=!1},b.fn.mbDbl=function(a){a.preventDefault(),this.active&&(this.active=!1,"annotate"===this.curOp&&(this.attHelper.endAtt(),this.updateControls()))},b.fn.mMove=function(a,b){if(this.active){var c=this.canvas.offset();this.x1=a-c.left,this.y1=b-c.top;var d=this.x1-this.x0,f=this.y1-this.y0;if("pan"===this.curOp)this.cHelper.doPan(d,f),this.x0=this.x1,this.y0=this.y1;else if("annotate"===this.curOp){var g=e(this.cHelper,this.x1,this.y1);this.attHelper.showPt(g),this.cHelper.repaint()}}},a.fn.annotator=function(c){var d,e;if("undefined"==typeof c.src)throw"Error: Input src (image source) is required";if("undefined"==typeof c.features)throw"Error: Input feature array is required";if(!c.features instanceof Array)throw"Error: input.features is not a valid Array instance";d="undefined"==typeof c.width?640:c.width,e="undefined"==typeof c.width?480:c.height;var f,g=a(this);return g.hasClass("annotator")?(f=g.data("Annotator"),f.update(c.src,d,e)):(f=new b(c.src,d,e),f.parent=g,f.build(g)),f.featuresIn(c),f.attsIn(c),f.cssIn(c),f.updateControls(),f.updateTitle(),f},c.fn=c.prototype,c.fn.getAtt=function(){return this.atts[this.aInd]},c.fn.getFtr=function(){return this.ftrs[this.fInd]},c.fn.reset=function(){this.atts=[new g(this.curType)],this.aInd=0,this.fInd=0,this.ftrs=[]},c.fn.addFtrData=function(a){this.ftrs.push(new f(a.name,a.required,a.shape))},c.fn.importFeatures=function(a){this.ftrs=[];for(var b=0;b<a.length;b++)this.addFtrData(a[b]);this.ftrChanged()},c.fn.importAtts=function(a){for(var b=0;b<this.ftrs.length;b++){var c=this.ftrs[b];if(c.atts=[],"undefined"!=typeof a[c.name])for(var d=a[c.name],e=d.shapes,f=0;f<e.length;f++){var h=e[f],i=new g(h.type);i.valid=!0,"rect"===h.type?(i.pts[0]=h.pos,i.pts[1]={x:h.pos.x+h.size.width,y:h.pos.y+h.size.height}):i.pts=h.points,c.atts.push(i)}}this.atts=this.getFtr().atts,this.parent.showChange()},c.fn.exportAtts=function(){for(var a={},b=0;b<this.ftrs.length;b++){var c=this.ftrs[b];a[c.name]={},a[c.name].shapes=[];for(var d=0;d<c.atts.length;d++){var e=c.atts[d];if("undefined"!=typeof e&&e.valid){var f={};if(f.type=e.type,"rect"===f.type){var g=e.pts[0].x,h=e.pts[0].y,i=e.pts[1].x,j=e.pts[1].y,k=Math.abs(i-g),l=Math.abs(j-h),m=Math.min(g,i),n=Math.min(h,j);f.pos={x:m,y:n},f.size={width:k,height:l}}else f.points=e.pts;a[c.name].shapes.push(f)}}}return a},c.fn.ftrChanged=function(){var a="any"!==this.getFtr().shape;this.parent.lockSelect(this.getFtr().shape,a),a&&(this.curType=this.getFtr().shape),this.atts=this.getFtr().atts,this.aInd=0,0===this.atts.length&&this.atts.push(new g(this.curType)),this.parent.showChange()},c.fn.nextFtr=function(){this.fInd++,this.fInd>=this.ftrs.length&&(this.fInd=this.ftrs.length-1),this.ftrChanged()},c.fn.prevFtr=function(){this.fInd--,this.fInd<0&&(this.fInd=0),this.ftrChanged()},c.fn.delAtt=function(){this.getAtt().reset()},c.fn.nextAtt=function(){this.aInd++,this.aInd===this.atts.length&&this.atts.push(new g(this.curType)),this.clrInvalid(),this.parent.showChange()},c.fn.prevAtt=function(){this.aInd--,this.aInd<0&&(this.aInd=0),this.clrInvalid(),this.parent.showChange()},c.fn.startAtt=function(a){this.getAtt().reset(this.curType),this.getAtt().valid=!0,this.getAtt().pts[0]=a,this.pInd=1},c.fn.showPt=function(a){"rect"===this.getAtt().type?this.getAtt().pts[1]=a:"poly"===this.getAtt().type&&(this.getAtt().pts[this.pInd]=a)},c.fn.nextPt=function(a){if("rect"===this.getAtt().type)return this.getAtt().pts[1]=a,!1;if("poly"===this.getAtt().type){var b=this.getAtt().pts[this.pInd-1];return(b.x!==a.x||b.y!==a.y)&&(this.getAtt().pts[this.pInd]=a,this.pInd++),!0}return!1},c.fn.endAtt=function(){"poly"===this.getAtt().type&&this.getAtt().pts.pop()},c.fn.changeType=function(a){this.curType=a},c.fn.clrInvalid=function(){for(var a=0;a<this.atts.length;a++)if(a!==this.aInd){var b=this.atts[a];b.valid||(this.atts.splice(a,1),this.aInd>a&&this.aInd--)}},d.fn=d.prototype,d.fn.repaint=function(){var a=this.g,b=this.parent.getFeatures();a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,this.w,this.h),a.translate(this.w/2+this.xOffs,this.h/2+this.yOffs),a.scale(this.curScale,this.curScale),a.shadowColor="#555",a.shadowBlur=40,a.drawImage(this.parent.img[0],-this.w/2,-this.h/2);for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<d.atts.length;e++)this.drawAtt(d.atts[e],c)},d.fn.drawAtt=function(a,b){var c=this.g,d=["rgb(255, 20, 20)","rgb(0, 200, 0)","rgb(00, 0, 255)","rgb(255, 255, 0)","rgb(50, 200, 200)"];if(a.valid){var e=d[b%d.length],f=e;if(a===this.parent.attHelper.getAtt()&&(f="white"),c.shadowColor="#000",c.shadowBlur=3,c.strokeStyle=e,c.lineWidth=1.5/this.curScale,c.fillStyle=f,"rect"===a.type){var g=a.pts[0].x,h=a.pts[0].y,i=a.pts[1].x,j=a.pts[1].y,k=Math.abs(i-g),l=Math.abs(j-h),m=Math.min(g,i),n=Math.min(h,j);c.strokeRect(m,n,k,l),this.drawPt({x:g,y:h}),this.drawPt({x:g,y:j}),this.drawPt({x:i,y:h}),this.drawPt({x:i,y:j})}else if("poly"===a.type){c.beginPath(),c.moveTo(a.pts[0].x,a.pts[0].y);for(var o=1;o<a.pts.length;o++)c.lineTo(a.pts[o].x,a.pts[o].y);for(c.lineTo(a.pts[0].x,a.pts[0].y),c.stroke(),o=0;o<a.pts.length;o++)this.drawPt(a.pts[o])}}},d.fn.drawPt=function(a){var b=this.g;b.beginPath(),b.arc(a.x,a.y,3/this.curScale,0,2*Math.PI,!1),b.fill()},d.fn.doPan=function(a,b){this.xOffs+=a,this.yOffs+=b;var c=this.w/2*this.curScale,d=this.h/2*this.curScale;this.xOffs>c&&(this.xOffs=c),this.xOffs<-c&&(this.xOffs=-c),this.yOffs>d&&(this.yOffs=d),this.yOffs<-d&&(this.yOffs=-d),this.repaint()},d.fn.zoom=function(a){this.curScale*=a,this.curScale<.9&&(this.curScale=.9),this.repaint()},d.fn.reset=function(a,b){this.canvas[0].width=a,this.canvas[0].height=b,this.w=a,this.h=b,this.xOffs=0,this.yOffs=0,this.curScale=this.defScale},g.prototype.reset=function(a){this.valid=!1,this.pts=[{x:0,y:0},{x:0,y:0}],null!=a&&(this.type=a)}}(jQuery);