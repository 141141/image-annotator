/*! penguinator - v3.7.0 - 2014-03-26
* https://github.com/felina/image-annotator
* Copyright (c) 2014 Alistair Wick <alistair.wk@gmail.com>; Licensed MIT */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){this.parent=a,this.reset()}var d=a("./feature"),e=a("./util").createAnnotation;c.fn=c.prototype,c.fn.getAnn=function(){return 0===this.anns.length?null:this.anns[this.aInd]},c.fn.replaceAnn=function(a){this.anns[this.aInd]=a},c.fn.setAnn=function(a){for(var b=0;b<this.ftrs.length;b++)for(var c=this.ftrs[b],d=0;d<c.anns.length;d++){var e=c.anns[d];if(e===a)return this.fInd=b,this.ftrChanged(),this.aInd=d,void(this.anns=this.getFtr().anns)}},c.fn.getFtr=function(){return 0===this.ftrs.length?null:this.ftrs[this.fInd]},c.fn.getFtrs=function(){return this.ftrs},c.fn.setFtr=function(a){for(var b=0;b<this.ftrs.length;b++)if(a===this.ftrs[b])return this.fInd=b,void this.ftrChanged()},c.fn.reset=function(){this.anns=[],this.aInd=0,this.fInd=0,this.ftrs=[],this.curType="rect"},c.fn.addFtrData=function(a){this.ftrs.push(new d(a.name,a.required,a.shape))},c.fn.importFeatures=function(a){this.ftrs=[],a||(a=[new d("Image",!1,"any")]);for(var b=0;b<a.length;b++)this.addFtrData(a[b]);this.parent.updateFtrs(this.ftrs),this.ftrChanged()},c.fn.importAnns=function(a){for(var b=0;b<this.ftrs.length;b++){var c=this.ftrs[b];if(c.anns=[],"undefined"!=typeof a[c.name])for(var d=a[c.name],f=d.shapes,g=0;g<f.length;g++){var h=f[g],i=e(h.type);i.valid=!0,"rect"===h.type?(i.pts[0]=h.pos,i.pts[1]={x:h.pos.x+h.size.width,y:h.pos.y+h.size.height}):i.pts=h.points,c.anns.push(i)}}this.anns=this.getFtr().anns,this.parent.showChange()},c.fn.exportAnns=function(){for(var a={},b=0;b<this.ftrs.length;b++){var c=this.ftrs[b];a[c.name]={},a[c.name].shapes=[];for(var d=0;d<c.anns.length;d++){var e=c.anns[d];if("undefined"!=typeof e&&e.valid){var f=e.getExport();a[c.name].shapes.push(f)}}}return a},c.fn.ftrChanged=function(){var a="any"!==this.getFtr().shape;this.parent.lockSelect(this.getFtr().shape,a),a&&(this.curType=this.getFtr().shape),this.anns=this.getFtr().anns,this.aInd=0,0===this.anns.length&&this.anns.push(e(this.curType)),this.parent.dispFtr(this.getFtr()),this.parent.showChange()},c.fn.nextFtr=function(){this.fInd++,this.fInd>=this.ftrs.length&&(this.fInd=this.ftrs.length-1),this.ftrChanged()},c.fn.prevFtr=function(){this.fInd--,this.fInd<0&&(this.fInd=0),this.ftrChanged()},c.fn.delAnn=function(){this.getAnn().invalidate()},c.fn.newAnn=function(){return this.anns.push(e(this.curType)),this.aInd=this.anns.length-1,this.getAnn()},c.fn.pickPt=function(a,b){var c={};c.pt=null,c.dist=1/0,c.ann=null,c.ind=0;for(var d=0;d<this.ftrs.length;d++)for(var e=this.ftrs[d].anns,f=0;f<e.length;f++)for(var g=e[f],h=g.getPts(),i=0;i<h.length;i++){var j=h[i],k=Math.sqrt(Math.pow(a-j.x,2)+Math.pow(b-j.y,2));k<c.dist&&(c.dist=k,c.pt=j,c.ind=i,c.ann=g)}return c},c.fn.pickLn=function(a,b){var c={};c.pt=null,c.dist=1/0,c.ann=null,c.i0=0,c.i1=0,c.endpt=!1;for(var d=0;d<this.ftrs.length;d++)for(var e=this.ftrs[d].anns,f=0;f<e.length;f++)for(var g=e[f],h=g.getDrawPts(),i=0;i<h.length-1;i++){var j=i,k=i+1,l=h[j],m=h[k],n=((a-l.x)*(m.x-l.x)+(b-l.y)*(m.y-l.y))/(Math.pow(m.x-l.x,2)+Math.pow(m.y-l.y,2)),o=!1;0>=n?(n=0,o=!0):n>=1&&(n=1,o=!0);var p={};p.x=l.x+n*(m.x-l.x),p.y=l.y+n*(m.y-l.y);var q=Math.sqrt(Math.pow(a-p.x,2)+Math.pow(b-p.y,2));q<c.dist&&(c.dist=q,c.pt=p,c.ann=g,c.i0=j,c.i1=k,c.endpt=o)}return c},c.fn.changeType=function(a){this.curType=a},c.fn.clrInvalid=function(){for(var a=0;a<this.anns.length;a++)if(a!==this.aInd){var b=this.anns[a];b.valid||(this.anns.splice(a,1),this.aInd>a&&this.aInd--)}},b.exports=c},{"./feature":5,"./util":14}],2:[function(a,b){function c(a,b,c){this.img=a,this.w=b,this.h=c,this.zoomin=null,this.zoomout=null,this.pan=null,this.annotate=null,this.edit=null,this.annType=null,this.ftrSel=null,this.delAnn=null,this.title=null,this.parent=null,this.container=null,this.canvas=null,this.curTool=new f(this),this.annHelper=new d(this),this.cHelper=null}var d=a("./annHelper"),e=a("./canvasHelper"),f=a("./tools/pan"),g=a("./tools/annotate"),h=a("./tools/edit"),i={position:"relative",overflow:"hidden"},j={position:"absolute",left:0,top:0,"z-index":100,cursor:"move"};c.fn=c.prototype,c.fn.featuresIn=function(a){"undefined"!=typeof a.features&&(this.annHelper.importFeatures(a.features),this.showChange())},c.fn.annsIn=function(a){"undefined"!=typeof a.annotations&&(this.annHelper.importAnns(a.annotations),this.showChange())},c.fn.cssIn=function(a){if("undefined"!=typeof a.style){var b=a.style,c=this.parent.find("button");"undefined"!=typeof b.classes&&c.addClass(b.classes),"undefined"!=typeof b.css&&c.css(b.css)}},c.fn.getExport=function(){return this.annHelper.exportAnns()},c.fn.getFeatures=function(){return this.annHelper.ftrs},c.fn.update=function(a,b,c){var d=this;this.img=a,null!==this.img&&this.img.load(function(){d.cHelper.imgLoaded(d.img)}),this.w=b,this.h=c,this.container.width(b).height(c),this.cHelper.reset(b,c),this.annHelper.reset()},c.fn.build=function(a){a.addClass("annotator"),a.data("Annotator",this),this.zoomin=$('<button id="zoomin">+</button>').appendTo(a),this.zoomout=$('<button id="zoomout">-</button>').appendTo(a),this.pan=$('<button id="pan">Pan</button>').appendTo(a),this.annotate=$('<button id="annot">Annotate</button>').appendTo(a),this.edit=$('<button id="edit">Edit</button>').appendTo(a).css("margin-right","20px"),this.annType=$('<select id="typesel"></select>').html("<option>Box</option><option>Polygon</option>").appendTo(a),this.delAnn=$('<button id="nextAnn">X</button>').appendTo(a).css("margin-right","20px"),this.title=$("<label>Annotating:</label>").appendTo(a).css("font-family","sans-serif").css("font-size","12px"),this.ftrSel=$('<select id="ftrsel"></select>').html("<option>Image</option>").prop("disabled",!0).appendTo(a),this.container=$("<div></div>").css(i).width(this.w).height(this.h).appendTo(a),this.canvas=$("<canvas>Unsupported browser.</canvas>").css(j).appendTo(this.container),this.canvas[0].onselectstart=function(){return!1},this.canvas[0].oncontextmenu=function(){return!1},this.cHelper=new e(this);var b=this;this.zoomin.click(function(){b.cHelper.zoom(1.25)}),this.zoomout.click(function(){b.cHelper.zoom(.8)}),this.annType.change(function(){var a=$(this).val();switch(a){case"Box":b.annHelper.changeType("rect"),b.switchOp("annotate");break;case"Polygon":b.annHelper.changeType("poly"),b.switchOp("annotate")}}),this.ftrSel.change(function(){for(var a=$(this).val(),c=b.annHelper.getFtrs(),d=0;d<c.length;d++){var e=c[d];if(a===e.fmtName())return void b.annHelper.setFtr(e)}}),this.pan.click(function(){b.switchOp("pan")}),this.annotate.click(function(){b.switchOp("annotate")}),this.edit.click(function(){b.switchOp("edit")}),this.delAnn.click(function(){b.annHelper.delAnn(),b.updateControls(),b.cHelper.repaint()}),this.canvas.mousedown(function(a){if(b.img)switch(a.which){case 1:b.curTool.lbDown(a.pageX,a.pageY);break;case 3:a.preventDefault(),b.curTool.rbDown(a.pageX,a.pageY)}}),this.canvas.mousemove(function(a){b.curTool.mMove(a.pageX,a.pageY)}),this.canvas.mouseup(function(a){if(b.img)switch(a.which){case 1:b.curTool.lbUp(a.pageX,a.pageY);break;case 3:a.preventDefault(),b.curTool.rbUp(a.pageX,a.pageY)}}),this.canvas.dblclick(function(a){return b.curTool.lbDbl(a.pageX,a.pageY),a.preventDefault(),!1}),this.update(this.img,this.w,this.h)},c.fn.showChange=function(){this.cHelper.repaint(),this.updateControls()},c.fn.lockSelect=function(a,b){this.img?(this.annType.prop("disabled",b),b&&this.annType.val("rect"===a?"Box":"Polygon")):this.annType.prop("disabled",!0)},c.fn.dispFtr=function(a){this.ftrSel.val(a.fmtName())},c.fn.updateFtrs=function(a){var b="";this.ftrSel.prop("disabled",!1);for(var c=0;c<a.length;c++){var d=a[c];b=b.concat("<option>"+d.fmtName()+"</option>")}this.ftrSel.empty().html(b)},c.fn.updateControls=function(){var a=this.annHelper;this.delAnn.prop("disabled",!a.getAnn().valid||!this.img),this.zoomin.prop("disabled",!this.img),this.zoomout.prop("disabled",!this.img),this.pan.prop("disabled",!this.img),this.annotate.prop("disabled",!this.img),this.edit.prop("disabled",!this.img)},c.fn.switchOp=function(a){switch(a){case"annotate":this.curTool=new g(this),this.canvas.css("cursor","crosshair");break;case"pan":this.curTool=new f(this),this.canvas.css("cursor","move");break;case"edit":this.curTool=new h(this),this.canvas.css("cursor","select")}},b.exports=c},{"./annHelper":1,"./canvasHelper":4,"./tools/annotate":11,"./tools/edit":12,"./tools/pan":13}],3:[function(a,b,c){var d=a("./annotator");c.annotator=function(a){var b,c;if("undefined"!=typeof a.src?a.img=$('<img src="'+a.src+'"></img>').hide():"undefined"==typeof a.img&&(a.img=null),"undefined"==typeof a.features)a.features=null;else if(!a.features instanceof Array)throw"Error: input.features is not a valid Array instance";b="undefined"==typeof a.width?640:a.width,c="undefined"==typeof a.width?480:a.height;var e,f=$(this);return f.hasClass("annotator")?(e=f.data("Annotator"),e.update(a.img,b,c)):(e=new d(a.img,b,c),e.parent=f,e.build(f)),e.featuresIn(a),e.annsIn(a),e.cssIn(a),e.showChange(),e}},{"./annotator":2}],4:[function(a,b){function c(a){this.parent=a;var b=a.w,c=a.h;this.canvas=a.canvas,this.g=this.canvas[0].getContext("2d"),this.canvas[0].width=b,this.canvas[0].height=c,this.w=b,this.h=c,this.imgW=b,this.imgH=c,this.defScale=1,this.curScale=this.defScale,this.xOffs=0,this.yOffs=0,this.hlt=null,this.select=[]}c.fn=c.prototype,c.fn.repaint=function(){var a=this.g,b=this.parent.getFeatures();a.setTransform(1,0,0,1,0,0),a.fillStyle="rgb(240, 240, 240)",a.fillRect(0,0,this.w,this.h),a.translate(this.w/2+this.xOffs,this.h/2+this.yOffs),a.scale(this.curScale,this.curScale),a.shadowColor="#555",a.shadowBlur=20,null!==this.parent.img?a.drawImage(this.parent.img[0],-this.imgW/2,-this.imgH/2):(a.fillStyle="rgb(220, 220, 220)",a.fillRect(-this.imgW/2,-this.imgH/2,this.imgW,this.imgH),a.shadowBlur=0,a.fillStyle="white",a.font="22px sans-serif",a.fillText("No Image",-40,-8));for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<d.anns.length;e++)this.drawAnn(d.anns[e],c);this.parent.curTool&&this.parent.curTool.draw(a)},c.fn.drawAnn=function(a,b){var c=this.g,d=[["rgb(255, 20, 20)","rgb(255, 80, 80)"],["rgb(0, 200, 0)","rgb(80, 240, 80)"],["rgb(0, 0, 255)","rgb(80, 80, 255)"],["rgb(255, 255, 0)","rgb(255, 255, 90)"],["rgb(50, 200, 200)","rgb(90, 255, 255)"]];if(a.valid){var e=d[b%d.length],f=e[0],g=0,h=!1;(a===this.hlt||this.parent.annHelper.getAnn()===a&&!this.hlt)&&(g=1,f=e[1],h=!0),c.shadowColor="#FFF",c.shadowBlur=0,c.fillStyle=f;var i=a.getDrawPts();c.beginPath(),c.moveTo(i[0].x,i[0].y);for(var j=1;j<i.length;j++)c.lineTo(i[j].x,i[j].y);if(c.strokeStyle=e[g],c.lineWidth=1.5/this.curScale,c.stroke(),h)for(j=0;j<i.length;j++)this.drawPt(i[j])}},c.fn.drawPt=function(a){var b=this.g;b.beginPath(),b.arc(a.x,a.y,3/this.curScale,0,2*Math.PI,!1),b.fill()},c.fn.doPan=function(a,b){this.xOffs+=a,this.yOffs+=b;var c=this.imgW/2*this.curScale,d=this.imgH/2*this.curScale;this.xOffs>c&&(this.xOffs=c),this.xOffs<-c&&(this.xOffs=-c),this.yOffs>d&&(this.yOffs=d),this.yOffs<-d&&(this.yOffs=-d),this.repaint()},c.fn.zoom=function(a){this.curScale*=a,this.curScale<this.defScale&&(this.curScale=this.defScale),this.doPan(0,0),this.repaint()},c.fn.reset=function(a,b){if(this.canvas[0].width=a,this.canvas[0].height=b,this.w=a,this.h=b,this.parent.img){var c=this.parent.img;this.imgW=c[0].width,this.imgH=c[0].height}else this.imgW=a,this.imgH=b;this.xOffs=0,this.yOffs=0,this.calcZoom(),this.curScale=this.defScale},c.fn.imgLoaded=function(a){this.imgW=a[0].width,this.imgH=a[0].height,this.calcZoom(),this.curScale=this.defScale,this.repaint()},c.fn.calcZoom=function(){var a=this.w/this.imgW,b=this.h/this.imgH,c=Math.min(a,b);this.defScale=.9*c},c.fn.setHlt=function(a){this.hlt=a},c.fn.ptToImg=function(a,b){var c=this.canvas.offset();a-=c.left,b-=c.top;var d=this,e=(a-d.w/2-d.xOffs)/d.curScale,f=(b-d.h/2-d.yOffs)/d.curScale;e<-d.imgW/2&&(e=-d.imgW/2),e>d.imgW/2&&(e=d.imgW/2),f<-d.imgH/2&&(f=-d.imgH/2),f>d.imgH/2&&(f=d.imgH/2);var g={x:e,y:f};return g},c.fn.scaleDist=function(a){return a/this.curScale},b.exports=c},{}],5:[function(a,b){function c(a,b,c){this.name=a,this.req=b,this.shape=c,this.anns=[],this.annC=0}c.fn=c.prototype,c.fn.fmtName=function(){var a=this.name.charAt(0).toUpperCase();return a.concat(this.name.substr(1))},b.exports=c},{}],6:[function(a){var b=a("./api");!function(a){a.fn.annotator=b.annotator}(jQuery)},{"./api":3}],7:[function(a,b){function c(){d.call(this),this.type="poly"}var d=a("../superShape");c.prototype=Object.create(d.prototype),c.fn=c.prototype,c.fn.addPt=function(a){return 0===this.pts.length?this.pts=[a,a]:this.pts.push(a),this.valid=!0,!0},c.fn.insPt=function(a,b){0>a||a>this.pts.length||this.pts.splice(a,0,b)},c.fn.canInsPt=function(){return!0},c.fn.modLastPt=function(a){this.pts.length>0&&(this.pts[this.pts.length-1]=a)},c.fn.modPt=function(a,b){a>=0&&a<this.pts.length&&(this.pts[a]=b)},c.fn.getDrawPts=function(){return this.pts.concat([this.pts[0]])},c.fn.delPt=function(a){this.pts.splice(a,1),this.pts.length<2&&(this.invalidate(),this.pts=[])},c.fn.getExport=function(){var a={};return a.type="poly",a.points=this.pts,a},b.exports=c},{"../superShape":9}],8:[function(a,b){function c(){d.call(this),this.type="rect"}var d=a("../superShape");c.prototype=Object.create(d.prototype),c.fn=c.prototype,c.fn.addPt=function(a){return 0===this.pts.length?(this.pts.push(a),this.pts.push(a),this.valid=!0,!0):(this.pts[1]=a,!1)},c.fn.modLastPt=function(a){2===this.pts.length&&(this.pts[1]=a)},c.fn.modPt=function(a,b){switch(a){case 0:this.pts[0]=b;break;case 1:this.pts[1].x=b.x,this.pts[0].y=b.y;break;case 2:this.pts[1]=b;break;case 3:this.pts[0].x=b.x,this.pts[1].y=b.y}},c.fn.getDrawPts=function(){if(!this.valid)return[];var a=[],b=this.pts[0].x,c=this.pts[0].y,d=this.pts[1].x,e=this.pts[1].y;return a.push({x:b,y:c}),a.push({x:d,y:c}),a.push({x:d,y:e}),a.push({x:b,y:e}),a.push({x:b,y:c}),a},c.fn.getPts=function(){return this.valid?this.getDrawPts().slice(0,-1):[]},c.fn.delPt=function(){this.invalidate()},c.fn.getExport=function(){var a={};a.type="rect";var b=this.pts[0].x,c=this.pts[0].y,d=this.pts[1].x,e=this.pts[1].y,f=Math.abs(d-b),g=Math.abs(e-c),h=Math.min(b,d),i=Math.min(c,e);return a.pos={x:h,y:i},a.size={width:f,height:g},a},b.exports=c},{"../superShape":9}],9:[function(a,b){function c(){this.valid=!1,this.pts=[],this.type="none"}c.fn=c.prototype,c.fn.invalidate=function(){this.valid=!1},c.fn.addPt=function(){},c.fn.modLastPt=function(){},c.fn.modPt=function(){},c.fn.insPt=function(){},c.fn.delPt=function(){},c.fn.getDrawPts=function(){return[]},c.fn.getExport=function(){return{}},c.fn.getNumPts=function(){return this.pts.length},c.fn.getPts=function(){return this.pts},c.fn.canInsPt=function(){return!1},b.exports=c},{}],10:[function(a,b){function c(){this.x0=0,this.x1=0,this.y0=0,this.y1=0,this.active=!1}c.fn=c.prototype,c.fn.lbDown=function(){},c.fn.lbUp=function(){},c.fn.lbDbl=function(){},c.fn.rbDown=function(){},c.fn.rbUp=function(){},c.fn.mMove=function(){},c.fn.draw=function(){},b.exports=c},{}],11:[function(a,b){function c(a){d.call(this),this.parent=a,this.ann=null}var d=a("../superTool");c.prototype=Object.create(d.prototype),c.fn=c.prototype,c.fn.lbUp=function(a,b){var c=this.parent;this.active||(this.active=!0,this.ann=c.annHelper.newAnn());var d=c.cHelper.ptToImg(a,b);this.active=this.ann.addPt(d),c.showChange()},c.fn.lbDbl=function(){if(this.active){var a=this.parent;this.active=!1,this.ann.delPt(-1),this.ann.delPt(-1),a.showChange()}},c.fn.mMove=function(a,b){if(this.active){var c=this.parent.cHelper,d=c.ptToImg(a,b);this.ann.modLastPt(d),c.repaint()}},b.exports=c},{"../superTool":10}],12:[function(a,b){function c(a){d.call(this),this.parent=a,this.canEdit=!1,this.editing=!1,this.editPt=0,this.hlt=null}var d=a("../superTool");c.prototype=Object.create(d.prototype),c.fn=c.prototype,c.fn.mMove=function(a,b){var c=this.parent,d=c.cHelper,e=d.ptToImg(a,b);if(this.editing){var f=c.annHelper.getAnn();f.modPt(this.editPt,e),this.hlt=e,c.showChange()}else this.passiveMove(e.x,e.y),c.showChange()},c.fn.lbUp=function(a,b){var c=this.parent.annHelper,d=this.parent.cHelper,e=d.ptToImg(a,b),f=c.getAnn();if(this.canEdit)if(this.editing)this.editing=!1;else{var g=c.pickPt(e.x,e.y);if(g.ann===f&&g.dist<d.scaleDist(15))return this.editPt=g.ind,void(this.editing=!0);if(f.canInsPt()){var h=c.pickLn(e.x,e.y);if(h.ann===f&&h.dist<d.scaleDist(15))return f.insPt(h.i1,e),this.editPt=h.i1,void(this.editing=!0)}}else{var i=c.pickLn(e.x,e.y);i.dist<d.scaleDist(15)&&c.setAnn(i.ann)}},c.fn.passiveMove=function(a,b){var c=this.parent.cHelper,d=this.parent.annHelper,e=d.pickPt(a,b),f=d.pickLn(a,b),g=null;if(e.dist<c.scaleDist(15))g=e;else{if(!(f.dist<c.scaleDist(15)))return this.canEdit=!1,this.hlt=null,void c.setHlt(null);g=f}g.ann===d.getAnn()?(this.canEdit=!0,this.hlt=g.pt):(this.canEdit=!1,this.hlt=null),c.setHlt(g.ann)},c.fn.rbUp=function(a,b){var c=this.parent.annHelper,d=this.parent.cHelper,e=d.ptToImg(a,b),f=c.getAnn();if(this.canEdit&&!this.editing){var g=c.pickPt(e.x,e.y);if(g.ann===f&&g.dist<d.scaleDist(15))return void f.delPt(g.ind)}},c.fn.draw=function(a){this.hlt&&(a.fillStyle="white",this.parent.cHelper.drawPt(this.hlt))},b.exports=c},{"../superTool":10}],13:[function(a,b){function c(a){d.call(this),this.parent=a}var d=a("../superTool");c.prototype=Object.create(d.prototype),c.fn=c.prototype,c.fn.lbDown=function(a,b){this.active||(this.x0=a,this.y0=b,this.active=!0)},c.fn.lbUp=function(){this.active=!1},c.fn.mMove=function(a,b){if(this.active){var c=a-this.x0,d=b-this.y0;this.parent.cHelper.doPan(c,d),this.x0=a,this.y0=b}},b.exports=c},{"../superTool":10}],14:[function(a,b,c){var d=a("./shapes/rect"),e=a("./shapes/poly");c.createAnnotation=function(a){switch(a){case"rect":return new d;case"poly":return new e}}},{"./shapes/poly":7,"./shapes/rect":8}]},{},[6]);